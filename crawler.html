<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>crawler</title>
<!-- 2013-10-14 Пн. 17:13 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="pimiento" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012  Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">crawler</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Основная идея</a></li>
<li><a href="#sec-2">2. Реализация</a></li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Основная идея</h2>
<div class="outline-text-2" id="text-1">
<p>
Необходимо собрать все задачи с <a href="http://acm.timus.ru/problemset.aspx">timus.ru</a>
и представить их в виде org-файла (timus.org).
</p>
<ul class="org-ul">
<li>Структура каждой задачи должны быть вида:
<div class="org-src-container">

<pre class="src src-org"><span style="color: #DFAF8F;">* {TODO|DONE} &#1080;&#1084;&#1103;-&#1079;&#1072;&#1076;&#1072;&#1095;&#1080;                                        </span><span style="color: #DFAF8F; font-weight: bold;">:&#1089;&#1083;&#1086;&#1078;&#1085;&#1086;&#1089;&#1090;&#1100;:</span>
  &#1090;&#1077;&#1082;&#1089;&#1090; &#1079;&#1072;&#1076;&#1072;&#1085;&#1080;&#1103;

  org-babel &#1074;&#1089;&#1090;&#1072;&#1074;&#1082;&#1072; &#1089; curl-&#1079;&#1072;&#1087;&#1088;&#1086;&#1089;&#1086;&#1084; &#1086;&#1090;&#1087;&#1088;&#1072;&#1074;&#1082;&#1080; &#1090;&#1077;&#1082;&#1089;&#1090;&#1086;&#1074;&#1086;&#1075;&#1086; &#1092;&#1072;&#1081;&#1083;&#1072; tasknum_timus.py
</pre>
</div>
</li>

<li>Создать для каждой задачи файл tasknum_timus.org с содержанием
<div class="org-src-container">

<pre class="src src-org" id="tasknum_timus">&#1058;&#1077;&#1082;&#1089;&#1090; &#1079;&#1072;&#1076;&#1072;&#1095;&#1080;

<span style="color: #ff4500;">#+name: &#1080;&#1084;&#1103;_&#1079;&#1072;&#1076;&#1072;&#1095;&#1080;</span>
<span style="color: #ff4500;">#+begin_src python :results output :shebang "#!/usr/bin/env python3" :tangle $ta</span><span style="color: #DC8CC3; background-color: #3F3F3F;">sknum_timus.py</span>

<span style="color: #ff4500;">#+end_src</span>
</pre>
</div>
</li>
<li>Ключ для обновления только основного файла, не трогающий файлы решений
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Реализация</h2>
<div class="outline-text-2" id="text-2">
<p>
Даные мы будем получать со страницы с таблицей задач
</p>
<div class="org-src-container">

<pre class="src src-python" id="crawler"><span style="color: #00ffff; font-weight: bold;">import</span> re
<span style="color: #00ffff; font-weight: bold;">import</span> os
<span style="color: #00ffff; font-weight: bold;">import</span> urllib
<span style="color: #00ffff; font-weight: bold;">import</span> urllib2
<span style="color: #00ffff; font-weight: bold;">import</span> logging
<span style="color: #00ffff; font-weight: bold;">from</span> lxml <span style="color: #00ffff; font-weight: bold;">import</span> html
<span style="color: #00ffff; font-weight: bold;">from</span> cookielib <span style="color: #00ffff; font-weight: bold;">import</span> CookieJar, Cookie

<span style="color: #eedd82;">TIMUS_URL</span> = <span style="color: #ffa07a;">"http://acm.timus.ru/"</span>
<span style="color: #eedd82;">TASKS_URL</span> = TIMUS_URL + <span style="color: #ffa07a;">"problemset.aspx?page=all"</span>
<span style="color: #eedd82;">AUTH_URL</span> = TIMUS_URL + <span style="color: #ffa07a;">"authedit.aspx"</span>
<span style="color: #eedd82;">PROBLEM_URL</span> = TIMUS_URL + <span style="color: #ffa07a;">"problem.aspx"</span>
<span style="color: #eedd82;">CONFIG_PATH</span> = <span style="color: #ffa07a;">"./crawler.conf"</span>
<span style="color: #eedd82;">OPENER</span> = <span style="color: #7fffd4;">None</span>

<span style="color: #00ffff; font-weight: bold;">with</span> <span style="color: #b0c4de;">open</span>(<span style="color: #ffa07a;">'./template.org'</span>, <span style="color: #ffa07a;">'r'</span>) <span style="color: #00ffff; font-weight: bold;">as</span> template_file:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   template = template_file.read()

logging.basicConfig(filename=<span style="color: #ffa07a;">'/tmp/logfile.txt'</span>, level=logging.DEBUG,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #b0c4de;">format</span>=<span style="color: #ffa07a;">'%(asctime)s - %(levelname)s - %(message)s'</span>)

<span style="color: #eedd82;">document</span> = {}

<span style="color: #00ffff; font-weight: bold;">class</span> <span style="color: #98fb98;">Task</span>(<span style="color: #b0c4de;">object</span>):

<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">__init__</span>(<span style="color: #00ffff; font-weight: bold;">self</span>, num, status, name, price):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">self</span>.num = <span style="color: #b0c4de;">int</span>(num)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">self</span>.status = status
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">self</span>.name = name
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">self</span>.price = price

<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #98fb98;">@property</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">url</span>(<span style="color: #00ffff; font-weight: bold;">self</span>):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> PROBLEM_URL + <span style="color: #ffa07a;">"?num=%d"</span> % <span style="color: #00ffff; font-weight: bold;">self</span>.num

<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">__str__</span>(<span style="color: #00ffff; font-weight: bold;">self</span>):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> u<span style="color: #ffa07a;">"{num} {status} {name} {price}"</span>.format(
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   num=<span style="color: #00ffff; font-weight: bold;">self</span>.num, status=<span style="color: #00ffff; font-weight: bold;">self</span>.status, name=<span style="color: #00ffff; font-weight: bold;">self</span>.name,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   price=<span style="color: #00ffff; font-weight: bold;">self</span>.price)

<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">get_task</span>(<span style="color: #00ffff; font-weight: bold;">self</span>):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> <span style="color: #ffa07a;">u"""* {status} {name:&lt;40}:{price}:\n{problem}\n{curl_query}"""</span>.fo<span style="color: #DC8CC3; background-color: #3F3F3F;">rmat(</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   status=<span style="color: #00ffff; font-weight: bold;">self</span>.status <span style="color: #00ffff; font-weight: bold;">and</span> u<span style="color: #ffa07a;">"DONE"</span> <span style="color: #00ffff; font-weight: bold;">or</span> u<span style="color: #ffa07a;">"TODO"</span>, name=<span style="color: #00ffff; font-weight: bold;">self</span>.name,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   price=<span style="color: #00ffff; font-weight: bold;">self</span>.price, problem=<span style="color: #00ffff; font-weight: bold;">self</span>.get_problem(),
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   curl_query=u<span style="color: #ffa07a;">"{curl-query}"</span>)

<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">table_to_org</span>(<span style="color: #00ffff; font-weight: bold;">self</span>, table):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> table.text_content()

<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">get_problem</span>(<span style="color: #00ffff; font-weight: bold;">self</span>):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   opener = get_opener()
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   doc = html.fromstring(opener.open(<span style="color: #00ffff; font-weight: bold;">self</span>.url).read())
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   problem_text = u<span style="color: #ffa07a;">""</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">try</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   problem_body = doc.xpath(<span style="color: #ffa07a;">"//div[contains(@id,'problem_text')]"</span>)[0]
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">except</span> <span style="color: #98fb98;">IndexError</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   logging.debug(<span style="color: #ffa07a;">'Problem no. {num} has no problem text'</span>.format(num=<span style="color: #00ffff; font-weight: bold;">sel</span><span style="color: #DC8CC3; background-color: #3F3F3F;">f.num))</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">else</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">for</span> element <span style="color: #00ffff; font-weight: bold;">in</span> problem_body:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">if</span> element.tag == <span style="color: #ffa07a;">"div"</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">if</span> <span style="color: #ffa07a;">'problem_source'</span> <span style="color: #00ffff; font-weight: bold;">in</span> element:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">continue</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   problem_text += u<span style="color: #ffa07a;">"{text}\n"</span>.format(
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   text=element.text_content())
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">elif</span> element.tag == <span style="color: #ffa07a;">"h3"</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   problem_text += u<span style="color: #ffa07a;">"** {text}\n"</span>.format(
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   text=element.text_content())
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">elif</span> element.tag == <span style="color: #ffa07a;">"table"</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   problem_text += u<span style="color: #ffa07a;">"{text}\n"</span>.format(
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   text=<span style="color: #00ffff; font-weight: bold;">self</span>.table_to_org(element))
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">finally</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> problem_text

<span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">get_secrets</span>():
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">if</span> os.path.isfile(CONFIG_PATH):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">with</span> <span style="color: #b0c4de;">open</span>(CONFIG_PATH, <span style="color: #ffa07a;">'r'</span>) <span style="color: #00ffff; font-weight: bold;">as</span> fd:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   config = fd.readlines()
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> parse_config(config)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">raise</span> <span style="color: #98fb98;">IOError</span>(<span style="color: #ffa07a;">"%s is absent!"</span> % CONFIG_PATH)

<span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">parse_config</span>(config):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   JUDGE_ID = <span style="color: #ffa07a;">""</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   PASSWORD = <span style="color: #ffa07a;">""</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   judgeid_regexp = re.compile(r<span style="color: #ffa07a;">'^JUDGE_ID'</span>)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   password_regexp = re.compile(r<span style="color: #ffa07a;">'^PASSWORD'</span>)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   comment_regexp = re.compile(r<span style="color: #ffa07a;">'^#'</span>)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">for</span> line <span style="color: #00ffff; font-weight: bold;">in</span> config:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">if</span> comment_regexp.match(line):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">continue</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">if</span> judgeid_regexp.match(line):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   JUDGE_ID = line.split(<span style="color: #ffa07a;">':'</span>)[1].strip()
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">if</span> password_regexp.match(line):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   PASSWORD = line.split(<span style="color: #ffa07a;">':'</span>)[1].strip()
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> JUDGE_ID, PASSWORD

<span style="color: #00ffff; font-weight: bold;">try</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   JUDGE_ID, PASSWORD = get_secrets()
<span style="color: #00ffff; font-weight: bold;">except</span> <span style="color: #98fb98;">IOError</span>, e:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   JUDGE_ID = <span style="color: #ffa07a;">"MYID"</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   PASSWORD = <span style="color: #ffa07a;">"PASSWORD"</span>


<span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">get_task_line</span>(task):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #ffa07a;">"""</span>
<span style="color: #ffa07a;">    XMLElement -&gt; [String, Bool, String, String]</span>
<span style="color: #ffa07a;">    """</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   status, num, name, <span style="color: #b0c4de;">_</span>, <span style="color: #b0c4de;">_</span>, price = task.getchildren()
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">if</span> status.find(<span style="color: #ffa07a;">'a'</span>) <span style="color: #00ffff; font-weight: bold;">is</span> <span style="color: #00ffff; font-weight: bold;">not</span> <span style="color: #7fffd4;">None</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   status = <span style="color: #ffa07a;">'ok.gif'</span> <span style="color: #00ffff; font-weight: bold;">in</span> status.find(<span style="color: #ffa07a;">'a'</span>).find(<span style="color: #ffa07a;">'img'</span>).attrib.get(<span style="color: #ffa07a;">'src'</span>)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">else</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   status = <span style="color: #00ffff; font-weight: bold;">False</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> [num.text_content(), status, name.text_content(), price.text_content(<span style="color: #DC8CC3; background-color: #3F3F3F;">)]</span>

<span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">get_opener</span>():
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">global</span> OPENER
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">if</span> OPENER:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> OPENER
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   cj = CookieJar()
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   ck = Cookie(version=0, name=<span style="color: #ffa07a;">'Locale'</span>, value=<span style="color: #ffa07a;">'Russian'</span>, port=<span style="color: #7fffd4;">None</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   port_specified=<span style="color: #00ffff; font-weight: bold;">False</span>, domain=<span style="color: #ffa07a;">'acm.timus.ru'</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   domain_specified=<span style="color: #00ffff; font-weight: bold;">False</span>, domain_initial_dot=<span style="color: #00ffff; font-weight: bold;">False</span>, path=<span style="color: #ffa07a;">'/'</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   path_specified=<span style="color: #00ffff; font-weight: bold;">True</span>, secure=<span style="color: #00ffff; font-weight: bold;">False</span>, expires=<span style="color: #7fffd4;">None</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   discard=<span style="color: #00ffff; font-weight: bold;">True</span>, comment=<span style="color: #7fffd4;">None</span>, comment_url=<span style="color: #7fffd4;">None</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   rest={<span style="color: #ffa07a;">'HttpOnly'</span>: <span style="color: #7fffd4;">None</span>}, rfc2109=<span style="color: #00ffff; font-weight: bold;">False</span>)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   cj.set_cookie(ck)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(cj))
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   data = urllib.urlencode({<span style="color: #ffa07a;">"Action"</span>: <span style="color: #ffa07a;">"edit"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>    <span style="color: #ffa07a;">"JudgeID"</span>: JUDGE_ID,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>    <span style="color: #ffa07a;">"Password"</span>: PASSWORD})
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   response = opener.open(AUTH_URL, data)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   OPENER = opener
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> opener

<span style="color: #eedd82;">fd</span> = get_opener().open(TASKS_URL)

<span style="color: #eedd82;">doc</span> = html.fromstring(fd.read())

<span style="color: #eedd82;">raw_tasks_list</span> = doc.body.find_class(<span style="color: #ffa07a;">'content'</span>)

<span style="color: #eedd82;">tasks_list</span> = []
<span style="color: #00ffff; font-weight: bold;">for</span> task <span style="color: #00ffff; font-weight: bold;">in</span> raw_tasks_list:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">if</span> task[0].tag == <span style="color: #ffa07a;">'th'</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">continue</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   tasks_list += [get_task_line(task)]

<span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">create_task</span>(num, status, name, price):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   document[num] = Task(num, status, name, price)

<span style="color: #00ffff; font-weight: bold;">for</span> task <span style="color: #00ffff; font-weight: bold;">in</span> tasks_list:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   create_task(*task)

<span style="color: #00ffff; font-weight: bold;">for</span> task <span style="color: #00ffff; font-weight: bold;">in</span> <span style="color: #b0c4de;">sorted</span>(document, key=<span style="color: #00ffff; font-weight: bold;">lambda</span> x: <span style="color: #b0c4de;">int</span>(document[x].price)):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   template += <span style="color: #ffa07a;">"\n"</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   template += document[task].get_task()
</pre>
</div>

<p>
Подготовим возможность логгировать ход выполения нашего скрипта
</p>
<div class="org-src-container">

<pre class="src src-python" id="logging">logging.basicConfig(filename=<span style="color: #ffa07a;">'/tmp/logfile.txt'</span>, level=logging.DEBUG,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #b0c4de;">format</span>=<span style="color: #ffa07a;">'%(asctime)s - %(levelname)s - %(message)s'</span>)
</pre>
</div>

<p>
Чтобы знать именно наши результаты,
нужно сначала авторизоваться в системе и получить нужные куки,
но сначала надо получить наши логин и пароль, если мы указали их в отдельном файле
</p>
<div class="org-src-container">

<pre class="src src-python" id="get_secrets"><span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">get_secrets</span>():
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">if</span> os.path.isfile(CONFIG_PATH):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">with</span> <span style="color: #b0c4de;">open</span>(CONFIG_PATH, <span style="color: #ffa07a;">'r'</span>) <span style="color: #00ffff; font-weight: bold;">as</span> fd:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   config = fd.readlines()
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> parse_config(config)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">raise</span> <span style="color: #98fb98;">IOError</span>(<span style="color: #ffa07a;">"%s is absent!"</span> % CONFIG_PATH)

<span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">parse_config</span>(config):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   JUDGE_ID = <span style="color: #ffa07a;">""</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   PASSWORD = <span style="color: #ffa07a;">""</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   judgeid_regexp = re.compile(r<span style="color: #ffa07a;">'^JUDGE_ID'</span>)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   password_regexp = re.compile(r<span style="color: #ffa07a;">'^PASSWORD'</span>)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   comment_regexp = re.compile(r<span style="color: #ffa07a;">'^#'</span>)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">for</span> line <span style="color: #00ffff; font-weight: bold;">in</span> config:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">if</span> comment_regexp.match(line):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">continue</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">if</span> judgeid_regexp.match(line):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   JUDGE_ID = line.split(<span style="color: #ffa07a;">':'</span>)[1].strip()
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">if</span> password_regexp.match(line):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   PASSWORD = line.split(<span style="color: #ffa07a;">':'</span>)[1].strip()
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> JUDGE_ID, PASSWORD

<span style="color: #00ffff; font-weight: bold;">try</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   JUDGE_ID, PASSWORD = get_secrets()
<span style="color: #00ffff; font-weight: bold;">except</span> <span style="color: #98fb98;">IOError</span>, e:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   JUDGE_ID = <span style="color: #ffa07a;">"MYID"</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   PASSWORD = <span style="color: #ffa07a;">"PASSWORD"</span>
</pre>
</div>
<p>
Необходимо установить все Cookie: русскую локаль и добавить систему хранения
куков авторизации  — CookieJar
</p>
<div class="org-src-container">

<pre class="src src-python" id="get_cookies"><span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">get_opener</span>():
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">global</span> OPENER
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">if</span> OPENER:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> OPENER
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   cj = CookieJar()
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   ck = Cookie(version=0, name=<span style="color: #ffa07a;">'Locale'</span>, value=<span style="color: #ffa07a;">'Russian'</span>, port=<span style="color: #7fffd4;">None</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   port_specified=<span style="color: #00ffff; font-weight: bold;">False</span>, domain=<span style="color: #ffa07a;">'acm.timus.ru'</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   domain_specified=<span style="color: #00ffff; font-weight: bold;">False</span>, domain_initial_dot=<span style="color: #00ffff; font-weight: bold;">False</span>, path=<span style="color: #ffa07a;">'/'</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   path_specified=<span style="color: #00ffff; font-weight: bold;">True</span>, secure=<span style="color: #00ffff; font-weight: bold;">False</span>, expires=<span style="color: #7fffd4;">None</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   discard=<span style="color: #00ffff; font-weight: bold;">True</span>, comment=<span style="color: #7fffd4;">None</span>, comment_url=<span style="color: #7fffd4;">None</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   rest={<span style="color: #ffa07a;">'HttpOnly'</span>: <span style="color: #7fffd4;">None</span>}, rfc2109=<span style="color: #00ffff; font-weight: bold;">False</span>)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   cj.set_cookie(ck)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(cj))
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   data = urllib.urlencode({<span style="color: #ffa07a;">"Action"</span>: <span style="color: #ffa07a;">"edit"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>    <span style="color: #ffa07a;">"JudgeID"</span>: JUDGE_ID,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>    <span style="color: #ffa07a;">"Password"</span>: PASSWORD})
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   response = opener.open(AUTH_URL, data)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   OPENER = opener
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> opener
</pre>
</div>

<p>
Получаем сырой xhtml
</p>
<div class="org-src-container">

<pre class="src src-python" id="get_data"><span style="color: #eedd82;">fd</span> = get_opener().open(TASKS_URL)
</pre>
</div>

<p>
И затем скармливаем его lxml и получаем тело страницы
</p>
<div class="org-src-container">

<pre class="src src-python" id="to_xml"><span style="color: #eedd82;">doc</span> = html.fromstring(fd.read())
</pre>
</div>

<p>
Каждая запись задачи хранится в элементе tr с классом <i>content</i>
</p>
<div class="org-src-container">

<pre class="src src-python" id="get_content"><span style="color: #eedd82;">raw_tasks_list</span> = doc.body.find_class(<span style="color: #ffa07a;">'content'</span>)
</pre>
</div>

<p>
Мы будем хранить наши записи в списке вида
[Номер(Integer), статус(True|False), название(String), стоимость(Integer)]
Среди прочих нам попадётся строчка таблицы заголовок, её нужно пропустить
</p>
<div class="org-src-container">

<pre class="src src-python" id="create_tasks_list"><span style="color: #eedd82;">tasks_list</span> = []
<span style="color: #00ffff; font-weight: bold;">for</span> task <span style="color: #00ffff; font-weight: bold;">in</span> raw_tasks_list:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">if</span> task[0].tag == <span style="color: #ffa07a;">'th'</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">continue</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   tasks_list += [get_task_line(task)]
</pre>
</div>

<p>
Заполнять задачи будем в следующем порядке:
</p>
<ol class="org-ol">
<li>Если в первом <i>td</i> содержится изображение "ok.gif" &#x2013; задача выполнена
</li>
<li>Второй <i>td</i> содержит номер задачи
</li>
<li>Третий <i>td</i> содержит название задачи
</li>
<li>Четвёртый и пятый <i>td</i> мы пропускаем
</li>
<li>Пятый <i>td</i> содержит стоимость задания
</li>
</ol>

<div class="org-src-container">

<pre class="src src-python" id="get_task_line"><span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">get_task_line</span>(task):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #ffa07a;">"""</span>
<span style="color: #ffa07a;">    XMLElement -&gt; [String, Bool, String, String]</span>
<span style="color: #ffa07a;">    """</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   status, num, name, <span style="color: #b0c4de;">_</span>, <span style="color: #b0c4de;">_</span>, price = task.getchildren()
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">if</span> status.find(<span style="color: #ffa07a;">'a'</span>) <span style="color: #00ffff; font-weight: bold;">is</span> <span style="color: #00ffff; font-weight: bold;">not</span> <span style="color: #7fffd4;">None</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   status = <span style="color: #ffa07a;">'ok.gif'</span> <span style="color: #00ffff; font-weight: bold;">in</span> status.find(<span style="color: #ffa07a;">'a'</span>).find(<span style="color: #ffa07a;">'img'</span>).attrib.get(<span style="color: #ffa07a;">'src'</span>)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">else</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   status = <span style="color: #00ffff; font-weight: bold;">False</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> [num.text_content(), status, name.text_content(), price.text_content(<span style="color: #DC8CC3; background-color: #3F3F3F;">)]</span>
</pre>
</div>

<p>
Осталось записать результат в org-file
</p>
<div class="org-src-container">

<pre class="src src-python" id="create_org"><span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">create_task</span>(num, status, name, price):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   document[num] = Task(num, status, name, price)

<span style="color: #00ffff; font-weight: bold;">for</span> task <span style="color: #00ffff; font-weight: bold;">in</span> tasks_list:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   create_task(*task)

<span style="color: #00ffff; font-weight: bold;">for</span> task <span style="color: #00ffff; font-weight: bold;">in</span> <span style="color: #b0c4de;">sorted</span>(document, key=<span style="color: #00ffff; font-weight: bold;">lambda</span> x: <span style="color: #b0c4de;">int</span>(document[x].price)):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   template += <span style="color: #ffa07a;">"\n"</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   template += document[task].get_task()
</pre>
</div>

<p>
Для хранения всего документа создадим класс записей задач
</p>
<div class="org-src-container">

<pre class="src src-python" id="objects"><span style="color: #eedd82;">document</span> = {}

<span style="color: #00ffff; font-weight: bold;">class</span> <span style="color: #98fb98;">Task</span>(<span style="color: #b0c4de;">object</span>):

<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">__init__</span>(<span style="color: #00ffff; font-weight: bold;">self</span>, num, status, name, price):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">self</span>.num = <span style="color: #b0c4de;">int</span>(num)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">self</span>.status = status
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">self</span>.name = name
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">self</span>.price = price

<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #98fb98;">@property</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">url</span>(<span style="color: #00ffff; font-weight: bold;">self</span>):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> PROBLEM_URL + <span style="color: #ffa07a;">"?num=%d"</span> % <span style="color: #00ffff; font-weight: bold;">self</span>.num

<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">__str__</span>(<span style="color: #00ffff; font-weight: bold;">self</span>):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> u<span style="color: #ffa07a;">"{num} {status} {name} {price}"</span>.format(
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   num=<span style="color: #00ffff; font-weight: bold;">self</span>.num, status=<span style="color: #00ffff; font-weight: bold;">self</span>.status, name=<span style="color: #00ffff; font-weight: bold;">self</span>.name,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   price=<span style="color: #00ffff; font-weight: bold;">self</span>.price)

<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   &lt;&lt;get_task&gt;&gt;

<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   &lt;&lt;get_problem&gt;&gt;
</pre>
</div>

<p>
Функция, возвращающая для каждой задачи запись в org-файл
</p>
<div class="org-src-container">

<pre class="src src-python" id="get_task"><span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">get_task</span>(<span style="color: #00ffff; font-weight: bold;">self</span>):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> <span style="color: #ffa07a;">u"""* {status} {name:&lt;40}:{price}:\n{problem}\n{curl_query}"""</span>.format<span style="color: #DC8CC3; background-color: #3F3F3F;">(</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   status=<span style="color: #00ffff; font-weight: bold;">self</span>.status <span style="color: #00ffff; font-weight: bold;">and</span> u<span style="color: #ffa07a;">"DONE"</span> <span style="color: #00ffff; font-weight: bold;">or</span> u<span style="color: #ffa07a;">"TODO"</span>, name=<span style="color: #00ffff; font-weight: bold;">self</span>.name,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   price=<span style="color: #00ffff; font-weight: bold;">self</span>.price, problem=<span style="color: #00ffff; font-weight: bold;">self</span>.get_problem(),
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   curl_query=u<span style="color: #ffa07a;">"{curl-query}"</span>)
</pre>
</div>

<p>
Получаем описание задачи с сайта
</p>
<div class="org-src-container">

<pre class="src src-python" id="get_problem"><span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">table_to_org</span>(<span style="color: #00ffff; font-weight: bold;">self</span>, table):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> table.text_content()

<span style="color: #00ffff; font-weight: bold;">def</span> <span style="color: #87cefa;">get_problem</span>(<span style="color: #00ffff; font-weight: bold;">self</span>):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   opener = get_opener()
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   doc = html.fromstring(opener.open(<span style="color: #00ffff; font-weight: bold;">self</span>.url).read())
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   problem_text = u<span style="color: #ffa07a;">""</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">try</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   problem_body = doc.xpath(<span style="color: #ffa07a;">"//div[contains(@id,'problem_text')]"</span>)[0]
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">except</span> <span style="color: #98fb98;">IndexError</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   logging.debug(<span style="color: #ffa07a;">'Problem no. {num} has no problem text'</span>.format(num=<span style="color: #00ffff; font-weight: bold;">self</span>.nu<span style="color: #DC8CC3; background-color: #3F3F3F;">m))</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">else</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">for</span> element <span style="color: #00ffff; font-weight: bold;">in</span> problem_body:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">if</span> element.tag == <span style="color: #ffa07a;">"div"</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">if</span> <span style="color: #ffa07a;">'problem_source'</span> <span style="color: #00ffff; font-weight: bold;">in</span> element:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">continue</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   problem_text += u<span style="color: #ffa07a;">"{text}\n"</span>.format(
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   text=element.text_content())
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">elif</span> element.tag == <span style="color: #ffa07a;">"h3"</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   problem_text += u<span style="color: #ffa07a;">"** {text}\n"</span>.format(
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   text=element.text_content())
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">elif</span> element.tag == <span style="color: #ffa07a;">"table"</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   problem_text += u<span style="color: #ffa07a;">"{text}\n"</span>.format(
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   text=<span style="color: #00ffff; font-weight: bold;">self</span>.table_to_org(element))
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">finally</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #00ffff; font-weight: bold;">return</span> problem_text
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: pimiento</p>
<p class="date">Created: 2013-10-14 Пн. 17:13</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.1.1 (<a href="http://orgmode.org">Org</a> mode 8.1.2)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
